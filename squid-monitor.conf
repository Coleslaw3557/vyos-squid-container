# Monitor mode configuration - logs all traffic without blocking
# Basic config
visible_hostname squid-filter
cache_dir ufs /var/cache/squid 100 16 256
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
coredump_dir /var/cache/squid
pid_filename /var/run/squid/squid.pid

# Log rotation - keep 7 days
logfile_rotate 7

# SSL certificate generation helper
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/cache/squid/ssl_db -M 4MB
sslcrtd_children 5

# Forward-proxy port for Squid's internal URLs (not exposed via NAT)
http_port 3128

# HTTP transparent interception
http_port 3129 intercept

# HTTPS transparent interception with SSL splice
https_port 3130 intercept ssl-bump \
    cert=/etc/squid/cert.pem \
    key=/etc/squid/key.pem

# Define SSL bump steps
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# SSL bump - peek at SNI, then splice (don't decrypt)
ssl_bump peek step1
ssl_bump splice all

# ACLs for monitoring
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# Deny non-standard ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# In monitor mode, allow all traffic (just log it)
http_access allow all