# Basic config
visible_hostname squid-filter
cache_dir ufs /var/cache/squid 100 16 256
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
coredump_dir /var/cache/squid
pid_filename /var/run/squid/squid.pid

# Log rotation - keep 7 days
logfile_rotate 7

# SSL certificate generation helper
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/cache/squid/ssl_db -M 4MB
sslcrtd_children 5

# HTTP interception
http_port 3129 intercept

# HTTPS interception with SSL splice
https_port 3130 intercept ssl-bump \
    cert=/etc/squid/cert.pem \
    key=/etc/squid/key.pem

# Define SSL bump steps
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# SSL bump - peek at SNI, then splice (don't decrypt)
ssl_bump peek step1
ssl_bump splice all

# ACLs for whitelisting - loaded from external file
acl allowed_ssl ssl::server_name "/etc/squid/allowed_domains.txt"
acl allowed_http dstdomain "/etc/squid/allowed_domains.txt"
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# Deny non-standard ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow whitelisted domains
http_access allow allowed_ssl
http_access allow allowed_http

# Deny everything else
http_access deny all